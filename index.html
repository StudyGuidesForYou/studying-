<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aurora ‚Äî Web OS (Full)</title>

<!-- Tailwind CDN (development; for production bundle your CSS) -->

<script src="https://cdn.tailwindcss.com"></script>

<!-- InteractJS for drag/resize -->

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

<!-- xterm for Terminal -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
<!-- JSZip for export -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{
  --bg1: linear-gradient(190deg,#081226 0%, #07192b 45%, #052b36 100%);
  --glass: rgba(255,255,255,0.06);
  --muted: rgba(255,255,255,0.65);
  --accent: #7c5cff;
  --accent-2: #00e5ff;
  --radius: 14px;
  --taskbar-height:56px;
}
*{box-sizing:border-box}
html,body,#root{height:100%}
body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:white;background:var(--bg1);-webkit-font-smoothing:antialiased}
#wallpaper{position:fixed;inset:0;background:radial-gradient(600px 300px at 10% 10%, rgba(124,92,255,0.12), transparent), radial-gradient(400px 200px at 85% 85%, rgba(0,229,255,0.06), transparent), linear-gradient(190deg,#0b1420,#052b36);filter:blur(0.6px) saturate(1.03)}
#desktop{position:absolute;inset:0;padding:28px;display:flex;flex-wrap:wrap;gap:16px;align-content:flex-start}
.desk-icon{width:88px;text-align:center;color:white;cursor:pointer;user-select:none;padding:8px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);transition:transform .12s, box-shadow .12s}
.desk-icon:hover{transform:translateY(-6px);box-shadow:0 20px 50px rgba(2,6,23,0.6)}
.desk-icon span{display:block;margin-top:6px;font-size:13px;max-width:88px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#taskbar{position:fixed;left:12px;right:12px;bottom:12px;height:var(--taskbar-height);padding:8px;display:flex;align-items:center;gap:12px;background:linear-gradient(180deg, rgba(10,12,16,0.45), rgba(7,9,12,0.6));backdrop-filter: blur(12px);border-radius:20px;box-shadow:0 10px 40px rgba(2,6,23,0.7);border:1px solid rgba(255,255,255,0.03)}
#start-button{width:48px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;cursor:pointer;box-shadow:0 8px 30px rgba(124,92,255,0.12)}
.tb-btn{height:40px;min-width:40px;padding:6px;border-radius:10px;background:transparent;border:none;cursor:pointer;color:white;display:flex;align-items:center;justify-content:center}
.win{position:absolute;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 20px 60px rgba(2,6,23,0.8);overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
.win-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);cursor:move}
.win-title{display:flex;gap:10px;align-items:center;font-weight:700}
.win-body{height:calc(100% - 48px);background:transparent;overflow:auto;padding:12px}
.ctx{position:fixed;background:#07121a;color:white;border-radius:10px;padding:8px;box-shadow:0 10px 30px rgba(2,6,23,0.6);display:none;z-index:9999}
.ctx button{display:block;width:100%;text-align:left;padding:8px;border-radius:8px;background:transparent;border:0;color:white;cursor:pointer}
.input,textarea,select{background:rgba(255,255,255,0.03);color:white;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px}
.small{font-size:13px;color:var(--muted)}
.file-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px}
.badge{background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:6px 10px;border-radius:999px;font-weight:700}
.toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.empty{color:rgba(255,255,255,0.45);padding:16px;border-radius:8px;background:rgba(255,255,255,0.01)}
.footer-small{font-size:12px;color:rgba(255,255,255,0.55)}
/* responsive */
@media (max-width:900px){#start-menu{left:12px;right:12px;width:auto;border-radius:12px}}
</style>

</head>
<body>
<div id="wallpaper"></div>
<div id="desktop" oncontextmenu="return false"></div>

<!-- Start Menu -->

<div id="start-menu" style="display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:90px;width:900px;max-width:calc(100% - 40px);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:14px;box-shadow:0 30px 70px rgba(2,6,23,0.7);color:white;z-index:600">
  <div style="display:flex;gap:14px">
    <div style="width:46%;min-width:260px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <div class="badge">A</div>
        <div>
          <div style="font-weight:800;font-size:18px">Aurora</div>
          <div class="small">Fast, tiny, modern web OS ‚Äî everything saved locally.</div>
        </div>
      </div>
      <div class="small" style="margin-top:6px">Pinned</div>
      <div id="pinned-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px"></div>
    </div>
    <div style="width:54%">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">All apps</div>
        <input id="start-search" class="input" placeholder="Search apps..." style="width:250px" />
      </div>
      <div id="all-apps" style="overflow:auto;height:420px;margin-top:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px"></div>
    </div>
  </div>
</div>

<!-- Taskbar -->

<div id="taskbar">
  <div id="start-button" title="Start (click or press Win)">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 3h4v4H3V3zM9 3h6v4H9V3zM15 3h6v4h-6V3zM3 9h4v6H3V9zM9 9h6v6H9V9zM15 9h6v6h-6V9zM3 15h4v6H3v-6zM9 15h6v6H9v-6zM15 15h6v6h-6v-6z" fill="white"/></svg>
  </div>
  <div id="taskbar-pinned" style="display:flex;gap:8px;align-items:center"></div>
  <div style="flex:1"></div>
  <div style="display:flex;gap:10px;align-items:center">
    <div id="tray-wifi" class="small">Aurora</div>
    <div id="tray-time" class="small"></div>
    <div id="tray-settings" class="tb-btn" title="Settings">‚öôÔ∏è</div>
  </div>
</div>

<!-- Context menu -->

<div id="ctx-menu" class="ctx" role="menu">
  <button id="ctx-new-file">New text file</button>
  <button id="ctx-upload-file">Upload file...</button>
  <button id="ctx-refresh">Refresh</button>
  <button id="ctx-wallpaper">Change wallpaper</button>
</div>

<!-- Windows root -->

<div id="windows-root"></div>

<!-- Hidden file input for uploads -->

<input id="file-picker" type="file" style="display:none" multiple />

<script>
/* ---------- Apps listing (hardcoded + previous web apps) ---------- */
const APPS = [
  {id:'aura-notepad', name:'Notepad', icon:'üìù', type:'app', run:notepadApp},
  {id:'aura-calc', name:'Calculator', icon:'üßÆ', type:'app', run:calculatorApp},
  {id:'aura-paint', name:'Paint', icon:'üé®', type:'app', run:paintApp},
  {id:'aura-terminal', name:'Terminal', icon:'üíª', type:'app', run:terminalApp},
  {id:'aura-files', name:'Files', icon:'üìÅ', type:'app', run:filesApp},
  {id:'aura-photos', name:'Photos', icon:'üñºÔ∏è', type:'app', run:photosApp},
  {id:'aura-music', name:'Music', icon:'üéµ', type:'app', run:musicApp},
  {id:'aura-browser', name:'Browser', icon:'üåê', type:'app', run:browserApp},
  {id:'aura-settings', name:'Settings', icon:'‚öôÔ∏è', type:'app', run:settingsApp},
  // web apps (kept from your previous list)
  {id:'DayDreamX', name:'DayDreamX', icon:'üí≠', type:'web', url:'https://study.info.north-kazakhstan.su.cdn.cloudflare.net/'},
  {id:'Velera', name:'Velera', icon:'üöÄ', type:'web', url:'https://zearn.buzz.cdn.cloudflare.net/'},
  {id:'Truffled', name:'Truffled', icon:'üçÑ', type:'web', url:'https://truffled.example/'},
  {id:'PeteZah', name:'PeteZah', icon:'üêæ', type:'web', url:'https://pete.example/'},
  {id:'UniUBv4', name:'UniUB v4', icon:'üéì', type:'web', url:'https://university.example/'},
  {id:'Rosin', name:'Rosin', icon:'ü™µ', type:'web', url:'https://lbbjwojcgm.antrak.org.tr/'},
  {id:'Nexus', name:'Nexus', icon:'üï∏Ô∏è', type:'web', url:'https://nexus-is.onthewifi.com/'},
  {id:'DogeUB', name:'DogeUB', icon:'üê∂', type:'web', url:'https://math.linked8.net/indev'},
  {id:'RammerHead', name:'RammerHead', icon:'üéß', type:'web', url:'https://geo.searchgpy.com/'},
  {id:'CBmagic', name:'CBmagic', icon:'‚ú®', type:'web', url:'https://soloo.fun/'},
  {id:'Axiom', name:'Axiom', icon:'üß©', type:'web', url:'https://ultralight.mwbread.com/'},
  {id:'Quasar', name:'Quasar', icon:'üåå', type:'web', url:'https://tuition.oneuniversity.info/'},
  {id:'Boredom', name:'Boredom', icon:'üòê', type:'web', url:'https://boredom.global.ssl.fastly.net/'},
  {id:'SomeStuff', name:'SomeStuff', icon:'üì¶', type:'web', url:'https://wmath.pages.dev/#prxy'},
  {id:'Galaxy', name:'Galaxy', icon:'üå†', type:'web', url:'https://frylight.jumpingcrab.com/'},
  {id:'Eldardo', name:'Eldardo', icon:'üõ∏', type:'web', url:'https://eldardo.net/app/'}
];

/* ---------- Persistent state ---------- */
const state = {
  z:100,
  pinned: JSON.parse(localStorage.getItem('aurora_pinned')||'["aura-files","aura-photos","aura-music","aura-browser"]'),
  notes: JSON.parse(localStorage.getItem('aurora_notes')||'{}'),
  calc: JSON.parse(localStorage.getItem('aurora_calc')||'""'),
  paint: JSON.parse(localStorage.getItem('aurora_paint')||'{}'),
  files: JSON.parse(localStorage.getItem('aurora_files')||'{"root":[{"id":"f_root_readme","name":"Welcome.txt","type":"text","content":"Welcome to Aurora! Double-click files to open.\\n\\nThis small OS stores everything locally in your browser."}]}'),
  photos: JSON.parse(localStorage.getItem('aurora_photos')||'[]'),
  music: JSON.parse(localStorage.getItem('aurora_music')||'[]'),
  browser: {bookmarks: JSON.parse(localStorage.getItem('aurora_bookmarks')||'[]'), tabs: []},
  wallpaper: localStorage.getItem('aurora_wallpaper') || '',
};
const desktop=document.getElementById('desktop');
const windowsRoot=document.getElementById('windows-root');
const startMenu=document.getElementById('start-menu');
const pinnedGrid=document.getElementById('pinned-grid');
const allAppsEl=document.getElementById('all-apps');
const taskbarPinned=document.getElementById('taskbar-pinned');
const trayTime=document.getElementById('tray-time');
const ctxMenu=document.getElementById('ctx-menu');
const filePicker=document.getElementById('file-picker');

/* ---------- Utils ---------- */
function saveState(){ localStorage.setItem('aurora_pinned', JSON.stringify(state.pinned)); localStorage.setItem('aurora_notes', JSON.stringify(state.notes)); localStorage.setItem('aurora_calc', JSON.stringify(state.calc)); localStorage.setItem('aurora_paint', JSON.stringify(state.paint)); localStorage.setItem('aurora_files', JSON.stringify(state.files)); localStorage.setItem('aurora_photos', JSON.stringify(state.photos)); localStorage.setItem('aurora_music', JSON.stringify(state.music)); localStorage.setItem('aurora_bookmarks', JSON.stringify(state.browser.bookmarks)); if(state.wallpaper) localStorage.setItem('aurora_wallpaper', state.wallpaper); }
function findApp(id){return APPS.find(a=>a.id===id||a.name===id);}
function uid(prefix='id'){return prefix+Math.random().toString(36).slice(2,9)}
function formatBytes(n){ if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; return (n/1024/1024).toFixed(2)+' MB' }

/* ---------- Desktop & Start rendering ---------- */
function renderDesktop(){
  desktop.innerHTML='';
  // small launcher icons grid
  APPS.forEach(app=>{
    const el=document.createElement('div'); el.className='desk-icon'; el.title=app.name;
    el.innerHTML=`<div style="font-size:36px">${app.icon}</div><span>${app.name}</span>`;
    el.ondblclick=()=>openAppWindow(app);
    el.onclick=()=>{el.animate([{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:160});};
    desktop.appendChild(el);
  });
  // drag & drop indicator
  desktop.addEventListener('dragover',e=>{e.preventDefault(); desktop.style.outline='2px dashed rgba(255,255,255,0.06)';});
  desktop.addEventListener('dragleave',e=>{desktop.style.outline='none'});
  desktop.addEventListener('drop',async e=>{e.preventDefault(); desktop.style.outline='none'; const files = Array.from(e.dataTransfer.files||[]); if(files.length) handleFilesUpload(files);});
}

function renderStartMenu(){
  pinnedGrid.innerHTML=''; state.pinned.forEach(id=>{
    const app=findApp(id); if(!app) return;
    const card=document.createElement('div'); card.className='file-row'; card.style.background='rgba(255,255,255,0.02)';
    card.innerHTML=`<div style="display:flex;align-items:center;gap:10px"><div style="font-size:20px">${app.icon}</div><div>${app.name}</div></div><div style="display:flex;gap:6px"><button class="tb-btn" title="Open" onclick="openAppWindow(findApp('${app.id}'))">Open</button><button class="tb-btn" title="Unpin" onclick="unpinApp('${app.id}')">‚Äî</button></div>`;
    pinnedGrid.appendChild(card);
  });
  allAppsEl.innerHTML='';
  APPS.forEach(app=>{
    const c=document.createElement('div'); c.style.display='flex'; c.style.alignItems='center'; c.style.gap='8px'; c.style.padding='8px'; c.style.borderRadius='8px';
    c.style.cursor='pointer'; c.onmouseover=()=>c.style.background='rgba(255,255,255,0.02)'; c.onmouseout=()=>c.style.background='transparent';
    c.innerHTML=`<div style="font-size:22px">${app.icon}</div><div style="flex:1">${app.name}</div><div style="display:flex;gap:6px"><button class="tb-btn" onclick="openAppWindow(findApp('${app.id}'))">Open</button><button class="tb-btn" title="Pin" onclick="pinApp('${app.id}')">üìå</button></div>`;
    allAppsEl.appendChild(c);
  });
}

/* ---------- Pinned actions ---------- */
function pinApp(id){ if(!state.pinned.includes(id)) state.pinned.unshift(id); saveState(); renderStartMenu(); renderTaskbar(); }
function unpinApp(id){ state.pinned = state.pinned.filter(x=>x!==id); saveState(); renderStartMenu(); renderTaskbar(); }

/* ---------- Windows system ---------- */
function openAppWindow(app,options={}){
  if(!app) return;
  const win = document.createElement('div'); win.className='win';
  const width = options.w || Math.min(window.innerWidth*0.8,900);
  const height = options.h || Math.min(window.innerHeight*0.72,600);
  win.style.width = width+'px'; win.style.height = height+'px';
  win.style.left = ((window.innerWidth - width)/2)+'px'; win.style.top = ((window.innerHeight - height)/2)+'px';
  win.style.zIndex = ++state.z;
  const id = uid('win_');
  const headerHTML = `<div class="win-header"><div class="win-title"><div style="font-size:20px">${app.icon}</div><div>${app.name}</div></div><div style="display:flex;gap:6px;align-items:center"><button class="tb-btn" title="Minimize" onclick="minimizeWin('${id}')">‚Äî</button><button class="tb-btn" title="Close" onclick="closeWin('${id}')">‚úñ</button></div></div>`;
  win.innerHTML = headerHTML + `<div class="win-body" id="${id}_body"></div>`;
  windowsRoot.appendChild(win);
  win.dataset.winId = id;
  // make draggable/resizable
  interact(win).draggable({allowFrom:'.win-header', listeners:{move:dragMove}}).resizable({
    edges:{left:true,right:true,bottom:true,top:true},
    listeners:{move:resizeMove}
  });
  state.z++; // persist z
  // add to taskbar
  addTaskbarButton(id, app);
  // render app content
  const container=document.getElementById(`${id}_body`);
  if(app.type==='app' && typeof app.run==='function') app.run(container, {winId:id});
  else if(app.type==='web') container.innerHTML = `<iframe src="${app.url}" style="width:100%;height:100%;border:0"></iframe>`;
  // store element reference
  win.dataset.appId = app.id;
  // click to focus
  win.addEventListener('mousedown', ()=>{win.style.zIndex = ++state.z});
}

function dragMove(event){
  const t = event.target;
  const x = (parseFloat(t.getAttribute('data-x'))||0) + event.dx;
  const y = (parseFloat(t.getAttribute('data-y'))||0) + event.dy;
  t.style.transform = `translate(${x}px,${y}px)`;
  t.setAttribute('data-x', x);
  t.setAttribute('data-y', y);
}
function resizeMove(event){
  const t = event.target;
  t.style.width = event.rect.width + 'px';
  t.style.height = event.rect.height + 'px';
  const x = (parseFloat(t.getAttribute('data-x'))||0) + event.deltaRect.left;
  const y = (parseFloat(t.getAttribute('data-y'))||0) + event.deltaRect.top;
  t.style.transform = `translate(${x}px,${y}px)`;
  t.setAttribute('data-x', x);
  t.setAttribute('data-y', y);
}
function closeWin(winId){ const el = Array.from(document.querySelectorAll('.win')).find(w=>w.dataset.winId===winId); if(el) el.remove(); removeTaskbarButton(winId); }
function minimizeWin(winId){ const el = Array.from(document.querySelectorAll('.win')).find(w=>w.dataset.winId===winId); if(el) el.style.display='none'; }
function addTaskbarButton(winId, app){
  const btn = document.createElement('button'); btn.className='tb-btn'; btn.id='tb_'+winId; btn.title=app.name;
  btn.innerHTML = `<div style="display:flex;align-items:center;gap:6px"><div style="font-size:16px">${app.icon}</div><div class="small" style="min-width:60px;text-align:left">${app.name}</div></div>`;
  btn.onclick=()=>{const w = Array.from(document.querySelectorAll('.win')).find(x=>x.dataset.winId===winId); if(!w) return; if(w.style.display==='none') w.style.display='block'; w.style.zIndex=++state.z; }
  taskbarPinned.appendChild(btn);
}
function removeTaskbarButton(winId){ const btn=document.getElementById('tb_'+winId); if(btn) btn.remove(); }

/* ---------- App implementations ---------- */

/* Notepad */
function notepadApp(container, opts){
  const id = opts?.winId || uid('notepad');
  container.innerHTML = `<div style="display:flex;flex-direction:column;height:100%"><div style="display:flex;gap:8px;margin-bottom:8px" class="toolbar"><button class="tb-btn" id="${id}_save">Save</button><button class="tb-btn" id="${id}_rename">Rename</button><div class="small" style="margin-left:auto">Auto-saves locally</div></div><textarea id="${id}_ta" style="flex:1;width:100%;resize:none;border-radius:8px;padding:10px" placeholder="Start typing..."></textarea></div>`;

const ta=document.getElementById(`${id}_ta`);
ta.value = state.notes['default']||'';
ta.addEventListener('input', ()=>{ state.notes['default']=ta.value; saveState(); });
document.getElementById(`${id}_save`).onclick = ()=>{ alert('Saved ‚Äî already auto-saved locally.'); }
}

/* Calculator */
function calculatorApp(container){
container.innerHTML = `<div style="width:100%;height:100%;display:flex;flex-direction:column"><input id="calc_disp" class="input" disabled style="padding:12px;font-size:20px;margin-bottom:8px" /><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">${['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+'].map(v=>`<button class="tb-btn" onclick="aurCalc('${v}')">${v}</button>`).join('')}</div></div>`;
window.aurCalcVal = state.calc || '';
document.getElementById('calc_disp').value = window.aurCalcVal;
window.aurCalc = function(v){
if(v==='='){ try{ window.aurCalcVal = String(eval(window.aurCalcVal)); }catch{ window.aurCalcVal='Error'; } }
else window.aurCalcVal+=v;
document.getElementById('calc_disp').value=window.aurCalcVal;
state.calc = window.aurCalcVal; saveState();
}
}

/* Paint (simple) */
function paintApp(container, opts){
container.innerHTML = `<div style="display:flex;flex-direction:column;height:100%"><div class="toolbar"><input id="paint-color" type="color" value="#ffffff" /><input id="paint-range" type="range" min="1" max="50" value="3" /><button class="tb-btn" id="paint-clear">Clear</button><button class="tb-btn" id="paint-save">Save</button></div><div style="flex:1;position:relative"><canvas id="paint-canvas" style="width:100%;height:100%;border-radius:8px;background:transparent"></canvas></div></div>`;
const canvas=document.getElementById('paint-canvas');
function resizeCanvas(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; const ctx=canvas.getContext('2d'); if(state.paint.canvas) { const img=new Image(); img.src=state.paint.canvas; img.onload=()=>ctx.drawImage(img,0,0,canvas.width,canvas.height);} }
window.addEventListener('resize', resizeCanvas);
setTimeout(resizeCanvas,50);
const ctx=canvas.getContext('2d'); ctx.lineCap='round'; let painting=false;
function start(e){ painting=true; ctx.beginPath(); const r=canvas.getBoundingClientRect(); ctx.moveTo(e.clientX - r.left, e.clientY - r.top); }
function end(){ painting=false; ctx.beginPath(); save(); }
function draw(e){ if(!painting) return; const r=canvas.getBoundingClientRect(); ctx.lineTo(e.clientX - r.left, e.clientY - r.top); ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX - r.left, e.clientY - r.top); }
canvas.addEventListener('mousedown', start); window.addEventListener('mouseup', end); window.addEventListener('mousemove', draw);
document.getElementById('paint-color').addEventListener('input', e=>ctx.strokeStyle=e.target.value);
document.getElementById('paint-range').addEventListener('input', e=>ctx.lineWidth=e.target.value);
document.getElementById('paint-clear').onclick = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); save(); }
document.getElementById('paint-save').onclick = ()=>{ save(); alert('Saved to local storage'); }
function save(){ state.paint.canvas = canvas.toDataURL(); saveState(); }
}

/* Terminal */
function terminalApp(container){
const term = new Terminal(); term.open(container); term.write('Aurora Terminal\r\n$ ');
}

/* Files (Explorer) */
function filesApp(container, opts){
container.innerHTML = `<div style="display:flex;flex-direction:column;height:100%"><div class="toolbar"><button class="tb-btn" id="files_new_file">New File</button><button class="tb-btn" id="files_new_folder">New Folder</button><button class="tb-btn" id="files_upload">Upload</button><button class="tb-btn" id="files_download_all">Download ZIP</button><div style="margin-left:auto" class="small">Root</div></div><div id="files_breadcrumb" class="small" style="margin-bottom:8px"></div><div id="files_view" style="flex:1;overflow:auto;border-radius:8px;padding:6px;background:rgba(255,255,255,0.01)"></div></div>`;
const view = document.getElementById('files_view');
let cwd = 'root';
function render(){
document.getElementById('files_breadcrumb').textContent = 'Aurora / ' + cwd;
view.innerHTML = '';
const list = state.files[cwd] || [];
if(list.length===0) view.innerHTML = `<div class="empty">This folder is empty. Drag files here or use Upload.</div>`;
list.forEach(it=>{
const row = document.createElement('div'); row.className='file-row'; row.style.marginBottom='8px';
row.innerHTML = `<div style="display:flex;align-items:center;gap:12px"><div style="font-size:22px">${it.type==='folder'?'üìÅ':(it.type==='image'?'üñºÔ∏è':it.type==='audio'?'üéµ':'üìÑ')}</div><div style="min-width:220px">${it.name}</div></div><div style="display:flex;gap:8px"><button class="tb-btn" onclick="openFile('${cwd}','${it.id}')">Open</button><button class="tb-btn" onclick="renameFile('${cwd}','${it.id}')">Rename</button><button class="tb-btn" onclick="deleteFile('${cwd}','${it.id}')">Delete</button><button class="tb-btn" onclick="downloadFile('${cwd}','${it.id}')">‚á©</button></div>`;
view.appendChild(row);
});
}
// actions
document.getElementById('files_new_file').onclick = ()=>{ const name = prompt('File name','New note.txt'); if(!name) return; const id = uid('f'); const obj={id,name,type:'text',content:''}; state.files[cwd] = state.files[cwd]||[]; state.files[cwd].push(obj); saveState(); render(); }
document.getElementById('files_new_folder').onclick = ()=>{ const name=prompt('Folder name','New folder'); if(!name) return; const id = uid('fld'); const obj={id,name,type:'folder'}; state.files[cwd]=state.files[cwd]||[]; state.files[cwd].push(obj); state.files[id]=[]; saveState(); render(); }
document.getElementById('files_upload').onclick = ()=>{ filePicker.onchange = ()=>{ handleFilesUpload(Array.from(filePicker.files)); filePicker.value=''; }; filePicker.click(); }
document.getElementById('files_download_all').onclick = ()=>{ downloadAllAsZip(); }
// expose helper functions globally for buttons in HTML
window.openFile = function(parent, id){
const list = state.files[parent]||[]; const it = list.find(x=>x.id===id); if(!it) return;
if(it.type==='text'){ // open in notepad window with content loaded
openAppWindow(findApp('aura-notepad'), {w:600,h:420});
setTimeout(()=>{ const ta=document.querySelector('.win-body textarea'); if(ta){ ta.value = it.content||''; ta.addEventListener('input', ()=>{ it.content = ta.value; saveState(); }); } }, 80);
} else if(it.type==='image'){ // open in photos
// ensure photo exists
if(it.content && !state.photos.find(p=>p.id===it.id)){ state.photos.push({id:it.id, data: it.content}); saveState(); }
openAppWindow(findApp('aura-photos'), {w:900,h:600});
} else if(it.type==='audio'){ // open in music and queue
if(it.content && !state.music.find(t=>t.id===it.id)) state.music.push({id:it.id,name:it.name,data:it.content}); saveState();
openAppWindow(findApp('aura-music'), {w:720,h:420});
} else if(it.type==='folder'){
// navigate into folder by re-rendering view (simple approach: swap cwd)
cwd = it.id; render();
} else if(it.url){ openAppWindow({id:'web-tab',name:it.name,icon:'üåê',type:'web',url:it.url}); }
}
window.renameFile = function(parent,id){ const list = state.files[parent]||[]; const it=list.find(x=>x.id===id); if(!it) return; const n=prompt('Rename',it.name); if(n){ it.name=n; saveState(); render(); } }
window.deleteFile = function(parent,id){ if(!confirm('Delete this item?')) return; const list = state.files[parent]||[]; const idx=list.findIndex(x=>x.id===id); if(idx>=0) list.splice(idx,1); // if folder, remove its children
if(state.files[id]) delete state.files[id]; saveState(); render();
}
window.downloadFile = function(parent,id){ const list = state.files[parent]||[]; const it = list.find(x=>x.id===id); if(!it) return; if(it.type==='text'){ const blob = new Blob([it.content||''],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = it.name; a.click(); URL.revokeObjectURL(url);} else if(it.content){ const a=document.createElement('a'); a.href=it.content; a.download = it.name; a.click(); }}
async function downloadAllAsZip(){
const zip = new JSZip();
for(const key of Object.keys(state.files)){
const folder = state.files[key];
for(const it of folder){
if(it.type==='text'){ zip.file(`${key}/${it.name}`, it.content||''); }
else if(it.content){
// dataURL -> binary
const data = dataURLtoBlob(it.content);
zip.file(`${key}/${it.name}`, data);
}
}
}
const content = await zip.generateAsync({type:'blob'});
const url = URL.createObjectURL(content); const a=document.createElement('a'); a.href = url; a.download = 'aurora-files.zip'; a.click(); URL.revokeObjectURL(url);
}
function dataURLtoBlob(dataurl) {
const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
for(let i=0;i<n;i++) u8arr[i]=bstr.charCodeAt(i);
return new Blob([u8arr],{type:mime});
}

render();
}

/* Photos (gallery + viewer + crop) */
function photosApp(container, opts){
container.innerHTML = `<div style="display:flex;flex-direction:column;height:100%"><div class="toolbar"><button class="tb-btn" id="photos_import">Import</button><button class="tb-btn" id="photos_clear">Clear all</button><div style="margin-left:auto" class="small">Photos</div></div><div id="photos_grid" style="flex:1;overflow:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;padding:6px"></div></div>`;
const grid=document.getElementById('photos_grid');
function render(){
grid.innerHTML='';
if(state.photos.length===0) grid.innerHTML = `<div class="empty">No photos yet. Drag & drop images to the desktop or use Import.</div>`;
state.photos.forEach((p,idx)=>{
const el=document.createElement('div'); el.style.borderRadius='8px'; el.style.overflow='hidden'; el.style.cursor='pointer'; el.style.background=`url(${p.data}) center/cover`;
el.style.height='140px';
el.onclick = ()=>openViewer(idx);
grid.appendChild(el);
});
}
document.getElementById('photos_import').onclick = ()=>{ filePicker.accept='image/*'; filePicker.onchange = ()=>{ handleFilesUpload(Array.from(filePicker.files)); filePicker.value=''; filePicker.accept=''; }; filePicker.click(); }
document.getElementById('photos_clear').onclick = ()=>{ if(confirm('Clear all photos?')){ state.photos=[]; saveState(); render(); } }
function openViewer(index){
// viewer window with rotate/crop/delete
openAppWindow({id:'photos-view',name:'Photo viewer',icon:'üñºÔ∏è',type:'app', run: (ct)=>{ ct.innerHTML = `<div style="height:100%;display:flex;flex-direction:column"><div class="toolbar"><button class="tb-btn" id="pv_prev">‚óÄ</button><button class="tb-btn" id="pv_next">‚ñ∂</button><button class="tb-btn" id="pv_rotate">Rotate</button><button class="tb-btn" id="pv_crop">Crop</button><button class="tb-btn" id="pv_delete">Delete</button><div style="margin-left:auto" class="small">Image ${index+1} / ${state.photos.length}</div></div><div style="flex:1;display:flex;align-items:center;justify-content:center;padding:8px"><canvas id="pv_canvas" style="max-width:100%;max-height:100%;border-radius:8px;background:rgba(0,0,0,0.2)"></canvas></div></div>`; setTimeout(()=>{ const canvas=document.getElementById('pv_canvas'); const ctx=canvas.getContext('2d'); let idx=index, angle=0;
function draw(){ const img=new Image(); img.src=state.photos[idx].data; img.onload=()=>{ const maxW = 1000, maxH=700; const ratio = Math.min(maxW/img.width, maxH/img.height,1); canvas.width = img.width*ratio; canvas.height = img.height*ratio; ctx.save(); ctx.clearRect(0,0,canvas.width,canvas.height); if(angle!==0){ ctx.translate(canvas.width/2,canvas.height/2); ctx.rotate(angle*Math.PI/180); ctx.drawImage(img, -canvas.width/2, -canvas.height/2, canvas.width, canvas.height); ctx.restore(); } else ctx.drawImage(img,0,0,canvas.width,canvas.height); }; }
draw();
document.getElementById('pv_prev').onclick = ()=>{ idx = (idx-1+state.photos.length)%state.photos.length; draw(); };
document.getElementById('pv_next').onclick = ()=>{ idx = (idx+1)%state.photos.length; draw(); };
document.getElementById('pv_rotate').onclick = ()=>{ angle = (angle+90)%360; draw(); };
document.getElementById('pv_delete').onclick = ()=>{ if(confirm('Delete this photo?')){ state.photos.splice(idx,1); saveState(); ct.querySelector('.win').remove(); render(); } };
document.getElementById('pv_crop').onclick = ()=>{ // very simple crop: take center square
const img=new Image(); img.src=state.photos[idx].data; img.onload=()=>{ const s=Math.min(img.width,img.height); const sx=(img.width-s)/2; const sy=(img.height-s)/2; const tmp=document.createElement('canvas'); tmp.width=s; tmp.height=s; const tctx=tmp.getContext('2d'); tctx.drawImage(img,sx,sy,s,s,0,0,s,s); state.photos[idx].data = tmp.toDataURL(); saveState(); draw(); render(); alert('Cropped to center square'); };
};
},60) }});
}
render();
}

/* Music (playlist + player + crossfade) */
function musicApp(container, opts){
container.innerHTML = `<div style="display:flex;flex-direction:column;height:100%"><div class="toolbar"><button class="tb-btn" id="music_import">Import</button><button class="tb-btn" id="music_clear">Clear</button><label class="small" style="margin-left:auto">Crossfade <input id="music_crossfade" type="checkbox" /></label></div><div style="display:flex;gap:12px;height:100%"><div style="flex:1;overflow:auto;padding:6px" id="music_list"></div><div style="width:340px;background:rgba(255,255,255,0.01);padding:10px;border-radius:8px"><div id="music_now" class="small">No track</div><div style="margin-top:10px"><button class="tb-btn" id="m_play">Play</button><button class="tb-btn" id="m_prev">Prev</button><button class="tb-btn" id="m_next">Next</button></div><div style="margin-top:10px"><input id="m_seek" type="range" min="0" max="100" value="0" style="width:100%" /></div><div style="margin-top:8px"><input id="m_volume" type="range" min="0" max="1" step="0.01" value="1" style="width:100%" /></div></div></div></div>`;
const listEl = document.getElementById('music_list');
const nowEl = document.getElementById('music_now');
const playBtn = document.getElementById('m_play'), prevBtn = document.getElementById('m_prev'), nextBtn = document.getElementById('m_next');
const seek = document.getElementById('m_seek'), vol = document.getElementById('m_volume'), crossfadeCheckbox = document.getElementById('music_crossfade');
document.getElementById('music_import').onclick = ()=>{ filePicker.accept='audio/*'; filePicker.onchange = ()=>{ handleFilesUpload(Array.from(filePicker.files)); filePicker.value=''; filePicker.accept=''; renderList(); }; filePicker.click(); }
document.getElementById('music_clear').onclick = ()=>{ if(confirm('Clear all tracks?')){ state.music=[]; saveState(); renderList(); } }

// player with two audio elements for crossfade
const a1 = new Audio(), a2 = new Audio(); a1.crossOrigin='anonymous'; a2.crossOrigin='anonymous';
let currentIndex = 0, active=1, updating=false;
function renderList(){
listEl.innerHTML=''; if(state.music.length===0) listEl.innerHTML=`<div class="empty">No tracks. Import audio files to play.</div>`; state.music.forEach((t,idx)=>{ const r=document.createElement('div'); r.className='file-row'; r.innerHTML=`<div style="display:flex;gap:12px;align-items:center"><div>üéµ</div><div style="min-width:180px">${t.name}</div></div><div style="display:flex;gap:6px"><button class="tb-btn" onclick="musicPlay(${idx})">Play</button><button class="tb-btn" onclick="musicDelete(${idx})">Delete</button></div>`; listEl.appendChild(r); });
document.querySelectorAll('[onclick^="musicPlay"]').forEach(x=>x.onclick=()=>{}); // noop to avoid default
}
window.musicPlay = function(idx){ if(typeof idx !== 'number') return; currentIndex = idx; startTrack(idx); }
window.musicDelete = function(idx){ if(confirm('Delete track?')){ state.music.splice(idx,1); saveState(); renderList(); } }
function startTrack(idx){
const track = state.music[idx]; if(!track) return;
const crossfade = crossfadeCheckbox.checked;
const inactive = active===1?a2:a1, activeEl = active===1?a1:a2;
inactive.src = track.data; inactive.currentTime = 0; inactive.volume = 0; inactive.play();
// fade
if(crossfade){
const fadeDur = 2.0; let t=0; const step = 0.05;
const iv = setInterval(()=>{ t+=step; const ratio = Math.min(t/fadeDur,1); inactive.volume = ratio * vol.value; activeEl.volume = (1-ratio)*vol.value; if(ratio>=1){ clearInterval(iv); active = active===1?2:1; activeEl.pause(); activeEl.currentTime=0; } }, step*1000);
} else {
// stop previous
activeEl.pause(); activeEl.currentTime=0; inactive.volume = vol.value; active = active===1?2:1;
}
nowEl.textContent = 'Now playing: ' + track.name;
// wire seek updates
inactive.ontimeupdate = ()=>{ if(!updating){ seek.max = Math.floor(inactive.duration||0); seek.value = Math.floor(inactive.currentTime||0); } };
seek.oninput = ()=>{ inactive.currentTime = seek.value; };
}
playBtn.onclick = ()=>{ const el = active===1?a1:a2; if(el.src){ if(el.paused) el.play(); else el.pause(); } }
prevBtn.onclick = ()=>{ currentIndex = Math.max(0,currentIndex-1); startTrack(currentIndex); }
nextBtn.onclick = ()=>{ currentIndex = Math.min(state.music.length-1,currentIndex+1); startTrack(currentIndex); }
vol.oninput = ()=>{ a1.volume = vol.value; a2.volume = vol.value; }
renderList();
}

/* Browser (tabs + bookmarks) */
function browserApp(container, opts){
container.innerHTML = `<div style="display:flex;flex-direction:column;height:100%"><div style="display:flex;gap:8px;align-items:center" class="toolbar"><input id="browser_addr" class="input" placeholder="https://example.com" style="flex:1" /><button class="tb-btn" id="browser_go">Go</button><button class="tb-btn" id="browser_new">New Tab</button><button class="tb-btn" id="browser_bookmark">‚òÖ</button></div><div id="browser_tabs" style="display:flex;gap:6px;margin-top:6px;overflow:auto"></div><div id="browser_view" style="flex:1;margin-top:8px;border-radius:8px;overflow:hidden;background:white"></div></div>`;
const tabsEl = document.getElementById('browser_tabs'), view = document.getElementById('browser_view');
let tabs = state.browser.tabs || [];
function renderTabs(){
tabsEl.innerHTML=''; tabs.forEach((t,idx)=>{ const b=document.createElement('div'); b.className='file-row'; b.style.marginRight='6px'; b.style.minWidth='180px'; b.innerHTML = `<div style="flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${t.title || t.url}</div><div style="display:flex;gap:6px"><button class="tb-btn" onclick="browserSwitch(${idx})">Open</button><button class="tb-btn" onclick="browserClose(${idx})">‚úñ</button></div>`; tabsEl.appendChild(b); });
}
function renderView(){
view.innerHTML = '';
if(tabs.length===0) view.innerHTML = `<div class="empty">No tabs. Use the address bar to open websites (note: some sites disallow iframe embedding).</div>`;
else {
const active = tabs[0];
const iframe = document.createElement('iframe'); iframe.src = active.url; iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.border='0';
view.appendChild(iframe);
}
}
document.getElementById('browser_new').onclick = ()=>{ const url = '[https://example.com](https://example.com)'; tabs.unshift({url, title:url}); state.browser.tabs = tabs; saveState(); renderTabs(); renderView(); }
document.getElementById('browser_go').onclick = ()=>{ const url = document.getElementById('browser_addr').value.trim(); if(!url) return; const normalized = ensureUrl(url); tabs.unshift({url:normalized, title:normalized}); state.browser.tabs = tabs; saveState(); renderTabs(); renderView(); }
document.getElementById('browser_bookmark').onclick = ()=>{ const url = tabs[0]?.url || document.getElementById('browser_addr').value; if(!url) return; state.browser.bookmarks.push({url, title:url}); saveState(); alert('Bookmarked'); }
window.browserSwitch = function(idx){ if(idx>=0 && idx<tabs.length){ const t = tabs.splice(idx,1)[0]; tabs.unshift(t); state.browser.tabs = tabs; saveState(); renderTabs(); renderView(); } }
window.browserClose = function(idx){ if(idx>=0 && idx<tabs.length) tabs.splice(idx,1); state.browser.tabs = tabs; saveState(); renderTabs(); renderView(); }
function ensureUrl(u){ if(u.startsWith('http')) return u; return 'https://'+u; }
renderTabs(); renderView();
}

/* Settings */
function settingsApp(container){
container.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><div style="display:flex;align-items:center;gap:8px"><div style="font-weight:800">Wallpaper</div><input type="file" id="settings_wallpaper" accept="image/*" /></div><div><div style="font-weight:700">Storage</div><div class="small">Everything is stored locally in your browser. Clearing site data will remove files.</div></div><div><button class="tb-btn" id="export_files">Export All Files (ZIP)</button><button class="tb-btn" id="clear_all">Clear All Data</button></div></div>`;
document.getElementById('settings_wallpaper').onchange = e=>{ const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ state.wallpaper = r.result; wallpaper.style.backgroundImage = `url('${state.wallpaper}')`; saveState(); alert('Wallpaper set'); }; r.readAsDataURL(f); }
document.getElementById('export_files').onclick = ()=>{ document.querySelector('#files_new_file')?.click(); alert('Use the Files app -> Download ZIP to export everything.'); }
document.getElementById('clear_all').onclick = ()=>{ if(confirm('Clear all Aurora data from localStorage?')){ localStorage.clear(); location.reload(); } }
}

/* ---------- Drag & Upload handling ---------- */
async function handleFilesUpload(fileList){
for(const f of fileList){
const name = f.name;
const data = await fileToDataURL(f);
const ext = (name.split('.').pop()||'').toLowerCase();
if(['png','jpg','jpeg','gif','webp','bmp'].includes(ext)){
const id = uid('img'); state.photos.push({id, name, data}); // also add to files
state.files['root'] = state.files['root']||[]; state.files['root'].push({id, name, type:'image', content:data});
} else if(['mp3','wav','ogg','m4a'].includes(ext)){
const id = uid('aud'); state.music.push({id, name, data}); state.files['root'] = state.files['root']||[]; state.files['root'].push({id, name, type:'audio', content:data});
} else {
// treat as generic file -> if text, store content, else as dataURL
if(f.type.startsWith('text') || ext==='txt' || ext==='json'){
const txt = await f.text();
const id=uid('txt'); state.files['root'] = state.files['root']||[]; state.files['root'].push({id,name,type:'text',content:txt});
} else {
const id=uid('bin'); state.files['root'] = state.files['root']||[]; state.files['root'].push({id,name,type:'binary',content:data});
}
}
}
saveState(); // quick notification
renderStartMenu(); renderDesktop();
}
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload = ()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* ---------- Misc UI & Context ---------- */
desktop.addEventListener('contextmenu', e=>{ e.preventDefault(); ctxMenu.style.left = e.clientX + 'px'; ctxMenu.style.top = e.clientY + 'px'; ctxMenu.style.display='block'; });
document.addEventListener('click', ()=> ctxMenu.style.display='none');
document.getElementById('ctx-new-file').onclick = ()=>{ openAppWindow(findApp('aura-notepad')); };
document.getElementById('ctx-upload-file').onclick = ()=>{ filePicker.onchange = ()=>{ handleFilesUpload(Array.from(filePicker.files)); filePicker.value=''; }; filePicker.click(); };
document.getElementById('ctx-refresh').onclick = ()=>{ renderDesktop(); renderStartMenu(); };
document.getElementById('ctx-wallpaper').onclick = ()=>{ openAppWindow(findApp('aura-settings')); };

/* ---------- Taskbar interactions ---------- */
document.getElementById('start-button').addEventListener('click', ()=>{ startMenu.style.display = startMenu.style.display==='none'?'flex':'none'; });
document.getElementById('start-search').addEventListener('input', ()=>{ const val = document.getElementById('start-search').value.toLowerCase(); Array.from(allAppsEl.children).forEach(c=> c.style.display = c.textContent.toLowerCase().includes(val)?'flex':'none'); });

/* ---------- Tray time ---------- */
function updateTrayTime(){ const d=new Date(); trayTime.textContent = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
setInterval(updateTrayTime,1000); updateTrayTime();

/* ---------- Wallpaper animation / style ---------- */
const wallpaper = document.getElementById('wallpaper');
if(state.wallpaper) wallpaper.style.backgroundImage = `url('${state.wallpaper}')`;
let hue=0;
function animateWallpaper(){ hue=(hue+0.06)%360; const g1 = `radial-gradient(600px 300px at 8% 12%, hsla(${hue},60%,45%,0.08), transparent)`, g2 = `radial-gradient(400px 200px at 85% 85%, hsla(${(hue+130)%360},60%,45%,0.04), transparent)`; wallpaper.style.background = `${g1}, ${g2}, linear-gradient(190deg,#071428,#052b36)`; requestAnimationFrame(animateWallpaper); }
animateWallpaper();

/* ---------- Init ---------- */
renderDesktop(); renderStartMenu();
renderTaskbar();
function renderTaskbar(){ taskbarPinned.innerHTML = ''; state.pinned.forEach(id=>{ const app = findApp(id); if(!app) return; const b=document.createElement('button'); b.className='tb-btn'; b.title=app.name; b.innerHTML=`<div style="display:flex;align-items:center;gap:6px"><div style="font-size:18px">${app.icon}</div></div>`; b.onclick = ()=>openAppWindow(app); taskbarPinned.appendChild(b); }); }
renderTaskbar();

/* ---------- File input fallback (global) ---------- */
filePicker.addEventListener('change', ()=>{ handleFilesUpload(Array.from(filePicker.files)); filePicker.value=''; });

/* ---------- Keyboard shortcuts ---------- */
window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ startMenu.style.display='none'; } if((e.ctrlKey||e.metaKey) && e.key==='b'){ e.preventDefault(); openAppWindow(findApp('aura-browser')); } if((e.ctrlKey||e.metaKey) && e.key==='m'){ e.preventDefault(); openAppWindow(findApp('aura-music')); } });

/* ---------- Save before unload ---------- */
window.addEventListener('beforeunload', ()=>{ saveState(); });

/* ---------- Final polish: small helpers exposed to console ---------- */
window.aurora = {state, saveState, openAppWindow, findApp};

</script>
</body>
</html>
